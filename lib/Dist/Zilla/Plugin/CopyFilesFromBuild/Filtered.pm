use 5.008001;
use strict;
use warnings;

package Dist::Zilla::Plugin::CopyFilesFromBuild::Filtered;
# ABSTRACT: Copy files from build directory, but filter out lines

our $VERSION = '0.001';

use Moose;
use Path::Tiny;
use Try::Tiny;

with qw/ Dist::Zilla::Role::AfterBuild /;

=attr copy

Specifies files to be copied from the build directory back to the
distribution source.  May be given multiple times.

=cut

has copy => (
    is      => 'ro',
    isa     => 'ArrayRef[Str]',
    default => sub { [] },
);

=attr filter

A regular expression given as string.  Any matching lines in copied files
will be filtered out of the copy.  It will be applied as follows:

    s{^$filter\n}{}mg

Thus, it is anchored at the start of a line to the newline at the end.

The default matches a comment with "generated by" as found in typical
generated *.PL files:  C<#.*generated by.*>

=cut

has filter => (
    is      => 'ro',
    isa     => 'Str',
    default => '#.*generated by.*',
);

sub mvp_multivalue_args { 'copy' }

sub after_build {
    my ( $self, $stash ) = @_;

    my $build_root = $stash->{build_root};

    for my $file ( @{ $self->copy } ) {
        next unless length $file;
        my $from = $build_root->file($file);
        my $to   = $self->zilla->root->file($file);
        $self->_copy_filtered( $from, $to ) if -e $from;
    }
}

sub _copy_filtered {
    my ( $self, $from, $to ) = @_;

    try {
        my $filter = $self->filter;
        my $guts   = path($from)->slurp_raw;
        $guts =~ s{^$filter\n}{}mg;
        path($to)->spew_raw($guts);
        $self->log("Copied $from to $to");
    }
    catch {
        $self->log_fatal("Unable to copy $from to $to: $_");
    }
}

__PACKAGE__->meta->make_immutable;

1;

=for Pod::Coverage mvp_multivalue_args after_build

=head1 SYNOPSIS

    [CopyFilesFromBuild::Filtered]
    copy = Makefile.PL

    [CopyFilesFromBuild::Filtered]
    copy = whatever.txt
    filter = #.*whatever.*

=head1 DESCRIPTION

This module copies files from the build directory to the source directory,
but filters out lines from the copied file.  It is designed in particular
for generated *.PL files, which often have unwanted "generated by" comments
that cause unwanted file churn under source control.

=head1 SEE ALSO

=for :list
* L<Dist::Zilla::Plugin::CopyFilesFromBuild>
* L<Dist::Zilla::Plugin::CopyReadmeFromBuild>
* L<Dist::Zilla::Plugin::CopyFilesFromRelease>
* L<Dist::Zilla::Plugin::CopyMakefilePLFromBuild>

=cut

# vim: ts=4 sts=4 sw=4 et tw=75:
